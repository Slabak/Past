<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Комната — baseline VR</title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden}
  #overlay{position:fixed;inset:0;display:grid;place-items:center;z-index:5;
    background:radial-gradient(ellipse at center,rgba(0,0,0,.75),rgba(0,0,0,.95));
    color:#fff;font:16px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #overlay button{padding:12px 18px;border:none;border-radius:10px;background:#ffb366;color:#000;cursor:pointer}
  .vr-btn{position:fixed;left:12px;bottom:12px;z-index:6;background:#1e1e1e;color:#fff;border:1px solid #444;border-radius:8px;padding:10px 14px;font:14px system-ui;cursor:pointer}
  .vr-btn[disabled]{opacity:.4;cursor:not-allowed}
</style>
</head>
<body>
  <div id="overlay">
    <div style="text-align:center">
      <div style="margin-bottom:12px;font-size:18px">Переносимся через портал…</div>
      <button id="enter">Войти</button>
      <div style="margin-top:10px;font-size:12px;opacity:.7">Экран и VR (Quest) поддерживаются</div>
    </div>
  </div>

  <script src="assets/js/three.min.js"></script>
  <script src="assets/js/OrbitControls.js"></script>
  <script src="assets/js/GLTFLoader.js"></script>
<script>
/* ========= Встроенная VR-кнопка (простая) ========= */
function createSimpleVRButton(renderer){
  const btn=document.createElement('button'); btn.className='vr-btn'; btn.textContent='Войти в VR';
  if(!('xr' in navigator)){ btn.textContent='VR не поддерживается'; btn.disabled=true; return btn; }
  let session=null;
  async function onEnd(){ session.removeEventListener('end', onEnd); session=null; btn.textContent='Войти в VR'; }
  async function onStart(s){ session=s; s.addEventListener('end', onEnd); await renderer.xr.setSession(s); btn.textContent='Выйти из VR'; }
  btn.addEventListener('click', async ()=>{
    try{
      if(!session){
        const s=await navigator.xr.requestSession('immersive-vr',{requiredFeatures:['local-floor']});
        onStart(s);
      } else { await session.end(); }
    }catch(e){ console.warn('XR error',e); }
  });
  return btn;
}

/* ========= Константы ========= */
const W=4,D=4,H=3;
const TEX_FLOOR='assets/textures/floor.jpg';
const TEX_WALL ='assets/textures/wall.jpg';
const TEX_CEIL ='assets/textures/potolok.jpg';
const MODEL_TABLE ='assets/models/table.glb';
const MODEL_BARREL='assets/models/barrel.glb';
const MODEL_DOOR  ='assets/models/door.glb';

/* ========= Глобалы ========= */
let scene,camera,renderer,controls,loopRunning=false;

/* ========= Инициализация ========= */
function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x0b0706);
  scene.fog=new THREE.Fog(0x120b08,6,14);

  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.05,100);
  camera.position.set(0,1.6,2.8);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.setSize(innerWidth,innerHeight);
  renderer.outputColorSpace=THREE.SRGBColorSpace;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure=1.05;
  renderer.shadowMap.enabled=true;
  renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  renderer.xr.enabled=true;
  document.body.appendChild(renderer.domElement);
  document.body.appendChild(createSimpleVRButton(renderer));

  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.target.set(0,1.2,0);
  controls.enableDamping=true;
  controls.enablePan=false;
  controls.enableZoom=false;
  controls.rotateSpeed=-0.8;
  controls.dampingFactor=0.12;

  // Свет
  scene.add(new THREE.HemisphereLight(0xffdcb8,0x1b0e0a,0.4));
  scene.add(new THREE.AmbientLight(0xffe0bb,0.18));
  const dir=new THREE.DirectionalLight(0xffb06a,1.2);
  dir.position.set(-2.5,3.2,1.5);
  dir.castShadow=true; dir.shadow.mapSize.set(2048,2048); dir.shadow.radius=6;
  scene.add(dir);
  const fire=new THREE.PointLight(0xffa860,0.55,5.0); fire.position.set(-1.4,1.15,1.1); scene.add(fire);

  // Геометрия комнаты
  const tl=new THREE.TextureLoader();
  const floorTex=tl.load(TEX_FLOOR); floorTex.wrapS=floorTex.wrapT=THREE.RepeatWrapping; floorTex.repeat.set(2,2); floorTex.colorSpace=THREE.SRGBColorSpace;
  const wallTex =tl.load(TEX_WALL ); wallTex.wrapS=wallTex.wrapT=THREE.ClampToEdgeWrapping; wallTex.colorSpace=THREE.SRGBColorSpace;
  const ceilTex =tl.load(TEX_CEIL ); ceilTex.wrapS=ceilTex.wrapT=THREE.RepeatWrapping; ceilTex.repeat.set(2,2); ceilTex.colorSpace=THREE.SRGBColorSpace;

  const floor=new THREE.Mesh(new THREE.PlaneGeometry(W,D), new THREE.MeshStandardMaterial({map:floorTex,roughness:.9}));
  floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

  const wallMat=new THREE.MeshStandardMaterial({map:wallTex,roughness:1});
  const back =new THREE.Mesh(new THREE.PlaneGeometry(W,H), wallMat); back.position.set(0,H/2,-D/2); scene.add(back);
  const front=new THREE.Mesh(new THREE.PlaneGeometry(W,H), wallMat); front.position.set(0,H/2, D/2); front.rotation.y=Math.PI; scene.add(front);
  const left =new THREE.Mesh(new THREE.PlaneGeometry(D,H), wallMat); left.position.set(-W/2,H/2,0); left.rotation.y= Math.PI/2; scene.add(left);
  const right=new THREE.Mesh(new THREE.PlaneGeometry(D,H), wallMat); right.position.set( W/2,H/2,0); right.rotation.y=-Math.PI/2; scene.add(right);

  const ceil=new THREE.Mesh(new THREE.PlaneGeometry(W,D), new THREE.MeshStandardMaterial({map:ceilTex,roughness:.85}));
  ceil.position.set(0,H,0); ceil.rotation.x=Math.PI/2; scene.add(ceil);

  // Модели
  const L=new THREE.GLTFLoader();
  // стол — у задней стены (с «зеркалом»)
  L.load(MODEL_TABLE,(g)=>{
    placeOnFloor(g.scene,1.2);
    g.scene.position.set(0,0,-D/2+0.55);
    scene.add(g.scene);
  });
  // бочка — у левой стены ближе к камере
  L.load(MODEL_BARREL,(g)=>{
    placeOnFloor(g.scene,0.9);
    g.scene.position.set(-W/2+0.65,0,1.10);
    g.scene.rotation.y=Math.PI*0.5;
    scene.add(g.scene);
  });
  // дверь — строго в плоскости передней стены, утоплена на 5мм
  L.load(MODEL_DOOR,(g)=>{
    placeOnFloor(g.scene,1.9);
    g.scene.rotation.y=Math.PI;
    g.scene.position.set(0,0, D/2-0.005);
    scene.add(g.scene);
  });

  // ресайз
  addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);
  });

  // один-единственный цикл
  if(!loopRunning){
    loopRunning=true;
    renderer.setAnimationLoop(()=>{
      controls.update();
      renderer.render(scene,camera);
    });
  }

  // старт кнопкой (чтоб не было автозвука/блоков)
  document.getElementById('enter').addEventListener('click',()=>{ document.getElementById('overlay').style.display='none'; },{once:true});
}

// нормализовать модель: масштаб до заданной диагонали + поставить на пол
function placeOnFloor(root,targetDiag){
  root.traverse(o=>{ if(o.isMesh){ o.castShadow=o.receiveShadow=true; }});
  const b=new THREE.Box3().setFromObject(root), size=b.getSize(new THREE.Vector3());
  const diag=size.length()||1, k=targetDiag/diag;
  root.scale.setScalar(k);
  const b2=new THREE.Box3().setFromObject(root);
  root.position.sub(b2.getCenter(new THREE.Vector3()));
  const b3=new THREE.Box3().setFromObject(root);
  root.position.y -= b3.min.y;
}

window.addEventListener('load', init);
</script>
</body>
</html>
