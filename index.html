<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Комната прошлого</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script src="assets/js/three.min.js"></script>
  <script src="assets/js/OrbitControls.js"></script>
  <script src="assets/js/GLTFLoader.js"></script>

  <script>
    // Сцена
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a0f0a);

    // Камера
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 1.6, 3);

    // Рендерер
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Контролы
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 1, 0);
    controls.enableDamping = true;
    controls.dampingFactor = 0.03;
    controls.maxPolarAngle = Math.PI / 2.1;
    controls.minDistance = 1;
    controls.maxDistance = 5;

    // Свет
    const ambientLight = new THREE.AmbientLight(0xffe5b0, 0.6);
    scene.add(ambientLight);
    const pointLight = new THREE.PointLight(0xffb080, 1.2, 20);
    pointLight.position.set(1, 2.5, 1);
    pointLight.castShadow = true;
    scene.add(pointLight);

    // Загрузка текстур
    const textureLoader = new THREE.TextureLoader();
    const floorTex = textureLoader.load('assets/textures/floor.jpg');
    const wallTex = textureLoader.load('assets/textures/wall.jpg');
    const mirrorTex = textureLoader.load('assets/textures/mirror.jpg');

    floorTex.wrapS = floorTex.wrapT = THREE.RepeatWrapping;
    floorTex.repeat.set(3, 3);
    wallTex.wrapS = wallTex.wrapT = THREE.RepeatWrapping;
    wallTex.repeat.set(2, 2);

    // Пол
    const floorGeo = new THREE.PlaneGeometry(10, 10);
    const floorMat = new THREE.MeshStandardMaterial({ map: floorTex, roughness: 0.9 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Стены
    const wallMat = new THREE.MeshStandardMaterial({ map: wallTex, roughness: 1 });
    const wall1 = new THREE.Mesh(new THREE.PlaneGeometry(10, 5), wallMat);
    wall1.position.set(0, 2.5, -5);
    scene.add(wall1);

    const wall2 = new THREE.Mesh(new THREE.PlaneGeometry(10, 5), wallMat);
    wall2.position.set(-5, 2.5, 0);
    wall2.rotation.y = Math.PI / 2;
    scene.add(wall2);

    const wall3 = new THREE.Mesh(new THREE.PlaneGeometry(10, 5), wallMat);
    wall3.position.set(5, 2.5, 0);
    wall3.rotation.y = -Math.PI / 2;
    scene.add(wall3);

    // Зеркало
    const mirrorGeo = new THREE.PlaneGeometry(1.2, 0.8);
    const mirrorMat = new THREE.MeshStandardMaterial({
      map: mirrorTex,
      metalness: 0.9,
      roughness: 0.1,
      envMapIntensity: 1
    });
    const mirror = new THREE.Mesh(mirrorGeo, mirrorMat);
    mirror.position.set(0, 1.6, -4.99);
    scene.add(mirror);

    // Модель
    const loader = new THREE.GLTFLoader();
    loader.load('assets/models/tub_model.glb', function (gltf) {
      const model = gltf.scene;
      model.position.set(0, 0, 0);
      model.traverse(obj => {
        if (obj.isMesh) obj.castShadow = true;
      });
      scene.add(model);
    });

    // Анимация
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Музыка
    const listener = new THREE.AudioListener();
    camera.add(listener);
    const sound = new THREE.Audio(listener);
    const audioLoader = new THREE.AudioLoader();
    audioLoader.load('assets/music/music.mp3', buffer => {
      sound.setBuffer(buffer);
      sound.setLoop(true);
      sound.setVolume(0.4);
      sound.play();
    });
  </script>
</body>
</html>
