<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–¢–µ—Å—Å–µ—Ä–∞–∫—Ç ‚Äî Menger sponge (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)</title>
<script src="./assets/js/three.min.js"></script>
<script src="./assets/js/OrbitControls.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:30;flex-direction:column;gap:10px}
  .bar{width:240px;height:6px;background:#222;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:#14b8a6}
  .menu{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:20}
  .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;background:#14b8a6;color:#00100e;box-shadow:0 4px 20px rgba(0,0,0,.35)}
  .btn.secondary{background:#1f2937;color:#cbd5e1}
  .hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;font-size:13px;z-index:5}
  .mute{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:10px;font-size:13px;z-index:6;cursor:pointer}
</style>
</head>
<body>
  <div id="loading" class="loading">
    <div>–°–æ–±–∏—Ä–∞—é —Ç–µ—Å—Å–µ—Ä–∞–∫—Ç‚Ä¶</div>
    <div class="bar"><i id="bar"></i></div>
  </div>

  <div id="menu" class="menu">
    <button id="btnVR" class="btn">–í–æ–π—Ç–∏ –≤ VR</button>
    <button id="btnSpectate" class="btn secondary">–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è</button>
  </div>

  <div class="hud">–ö–ª–∏–∫/—Ç–∞–ø/–ø—Ä–æ–±–µ–ª ‚Äî ¬´—Å—Ç—É–∫¬ª. –ö–∞–º–µ—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –ø—É—Å—Ç–æ—Ç—ã, –≤–æ–∫—Ä—É–≥ –∫—Ä–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–ª—ë—Ç—ã.</div>
  <button id="mute" class="mute">üîä –ú—É–∑—ã–∫–∞</button>

<script>
/* ===== –∑–∞–≥—Ä—É–∑–∫–∞ ===== */
const manager = new THREE.LoadingManager();
manager.onProgress = (_url, loaded, total)=>{ document.getElementById('bar').style.width = ((loaded/total)*100|0)+'%'; };
manager.onLoad = ()=>{ loading.style.display='none'; menu.style.display='flex'; };
manager.onError = ()=>{ loading.style.display='none'; menu.style.display='flex'; };

/* ===== renderer/camera/scene ===== */
const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
const isMobile = /Android|iPhone|iPad|iPod|Quest|Oculus/i.test(navigator.userAgent);
renderer.setPixelRatio(isMobile ? 1 : Math.min(window.devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
// —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ three:
if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.35;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 500);
camera.position.set(0,1.6,0.01);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enabled = false; controls.target.set(0,1.6,0);

/* ===== fade + XR fix ===== */
function makeFade(){const g=new THREE.PlaneGeometry(2,2),m=new THREE.MeshBasicMaterial({color:0x000,transparent:true,opacity:1,depthTest:false});const q=new THREE.Mesh(g,m);q.renderOrder=9999;q.position.z=-0.3;camera.add(q);scene.add(camera);return{show:()=>m.opacity=1,fade:(ms=700)=>{const t0=performance.now();(function f(t){const k=Math.min(1,(t-t0)/ms);m.opacity=1-k;if(k<1)requestAnimationFrame(f)})(t0)}}}
const screen = makeFade();
let xrFadePending=false, xrFrameCount=0;

/* ===== —Å–≤–µ—Ç ===== */
const key = new THREE.DirectionalLight(0xffe0b5, 0.42); key.position.set(-2.5,5,-4.5); scene.add(key);
const rim = new THREE.DirectionalLight(0x9bbfff, 0.16); rim.position.set(3,2,3.5); scene.add(rim);
scene.add(new THREE.AmbientLight(0x0c0906, 0.55));

/* ===== –º–∞—Ç–µ—Ä–∏–∞–ª—ã: –¥–µ—Ä–µ–≤–æ –∏ ¬´—Å—Ç–µ–∫–ª–æ¬ª (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ) ===== */
function woodTex(){
  const c=document.createElement('canvas'); c.width=1024; c.height=64; const ctx=c.getContext('2d');
  for(let x=0;x<c.width;x++){
    const hue=35+Math.random()*10, sat=25+Math.random()*20, l=14+Math.random()*10;
    ctx.fillStyle=`hsl(${hue} ${sat}% ${l}%)`; ctx.fillRect(x,0,1,c.height);
  }
  const t=new THREE.CanvasTexture(c);
  t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(8,1);
  // –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π –Ω–µ —Ç—Ä–æ–≥–∞–µ–º colorSpace
  if ('colorSpace' in t) t.colorSpace = THREE.SRGBColorSpace;
  else t.encoding = THREE.sRGBEncoding;
  return t;
}
const wood = woodTex();
const matWood = new THREE.MeshStandardMaterial({map:wood, roughness:0.95, metalness:0.05, color:0xffffff});

// ¬´—Å—Ç–µ–∫–ª–æ¬ª –±–µ–∑ transmission/thickness (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ three)
const matGlass = new THREE.MeshStandardMaterial({
  color: 0xffffff,
  metalness: 0.05,
  roughness: 0.08,
  transparent: true,
  opacity: 0.35,      // —Å—Ç–µ–ø–µ–Ω—å ¬´—Å—Ç–µ–∫–ª—è–Ω–Ω–æ—Å—Ç–∏¬ª
  envMapIntensity: 0.6
});

/* ===== –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä Menger ===== */
function buildMenger(order=2, size=6.5, beam=0.10){
  const group = new THREE.Group();
  const boxGeo = new THREE.BoxGeometry(1,1,beam);
  const pieces = [];
  function addBeam(x,y,z, sx,sy,sz, axis){
    const useGlass = Math.random()<0.3;
    const m = new THREE.Mesh(boxGeo, (useGlass? matGlass : matWood).clone());
    m.scale.set(sx, sy, 1);
    if(axis==='x') m.rotation.y = Math.PI/2;
    if(axis==='y') m.rotation.x = Math.PI/2;
    m.position.set(x,y,z);
    pieces.push(m);
  }
  function recurse(cx,cy,cz, s, lvl){
    if(lvl===order) return;
    const step = s/3;
    const len = s; const thick = beam * (1 + 0.15*lvl);
    addBeam(cx,cy,cz, len, thick, thick,'x');
    addBeam(cx,cy,cz, thick, len, thick,'y');
    addBeam(cx,cy,cz, thick, thick, len,'z');
    for(let ix=-1; ix<=1; ix++) for(let iy=-1; iy<=1; iy++) for(let iz=-1; iz<=1; iz++){
      const sum = Math.abs(ix)+Math.abs(iy)+Math.abs(iz);
      if(sum===0 || sum===1) continue;
      recurse(cx+ix*step, cy+iy*step, cz+iz*step, step, lvl+1);
    }
  }
  recurse(0,1.6,0, size, 0);
  pieces.forEach(m=>group.add(m));
  return group;
}
const sponge = buildMenger(2, 6.5, 0.10);
scene.add(sponge);

// –ª—ë–≥–∫–æ–µ ¬´–¥—ã—Ö–∞–Ω–∏–µ¬ª
sponge.userData.update = (dt,t)=>{
  sponge.rotation.y = Math.sin(t*0.04)*0.06;
  sponge.position.x = Math.sin(t*0.06+1.2)*0.18;
  sponge.position.z = Math.sin(t*0.08)*0.22;
};

/* ===== –∑–≤—É–∫ ===== */
let audioCtx=null, musicNode=null, musicGain=null, musicStarted=false, musicMuted=false;
async function ensureMusic(){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(musicStarted) return;
    const resp=await fetch('./assets/music/universe.mp3'); const buf=await resp.arrayBuffer();
    const audioBuf=await audioCtx.decodeAudioData(buf);
    musicGain=audioCtx.createGain(); musicGain.gain.value=0.0001;
    musicNode=audioCtx.createBufferSource(); musicNode.buffer=audioBuf; musicNode.loop=true;
    musicNode.connect(musicGain).connect(audioCtx.destination); musicNode.start();
    const t=audioCtx.currentTime; musicGain.gain.exponentialRampToValueAtTime(0.10, t+2.0);
    musicStarted=true; updateMuteUI();
  }catch(e){ console.warn('–ú—É–∑—ã–∫—É –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å:', e); }
}
function setMuted(m){ musicMuted=m; if(musicGain){ const t=audioCtx.currentTime; musicGain.gain.cancelScheduledValues(t); musicGain.gain.exponentialRampToValueAtTime(m?0.0001:0.10, t+0.25);} updateMuteUI(); }
function toggleMute(){ setMuted(!musicMuted); }
function updateMuteUI(){ document.getElementById('mute').textContent = musicMuted ? 'üîá –ë–µ–∑ –∑–≤—É–∫–∞' : 'üîä –ú—É–∑—ã–∫–∞'; }
function thump(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(95,t);
  g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.22,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.5);
  o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.52);
}
function cameraShake(){let t0=performance.now();(function tick(){const dt=(performance.now()-t0)/1000,k=Math.max(0,0.35-dt);camera.position.x=0.006*Math.sin(dt*40)*k;camera.position.y=1.6+0.004*Math.sin(dt*55)*k;if(k>0)requestAnimationFrame(tick);else{camera.position.x=0;camera.position.y=1.6;}})();}
function triggerWave(){ ensureMusic(); thump(); cameraShake(); }

/* ===== XR/–º–µ–Ω—é ===== */
const loading=document.getElementById('loading');
const menu=document.getElementById('menu');
renderer.xr.addEventListener('sessionstart', ()=>{
  controls.enabled=false;
  screen.show();
  xrFadePending = true;
  xrFrameCount = 0;
  ensureMusic();
});
document.getElementById('btnVR').onclick   = async ()=>{ menu.style.display='none'; screen.show(); await startXR(); };
document.getElementById('btnSpectate').onclick = ()=>{ menu.style.display='none'; controls.enabled=true; screen.show(); ensureMusic(); setTimeout(()=>screen.fade(700),150); };
document.getElementById('mute').onclick = ()=>{ ensureMusic().then(()=>toggleMute()); };

/* ===== main loop (XR-fade –Ω–∞ 4 –∫–∞–¥—Ä–∞) ===== */
renderer.setAnimationLoop(()=>{
  if (renderer.xr.isPresenting && xrFadePending) {
    xrFrameCount++;
    if (xrFrameCount >= 4) { screen.fade(700); xrFadePending = false; }
  }
  const t=performance.now()*0.001;
  if (sponge.userData.update) sponge.userData.update(1/60,t);
  if(controls.enabled) controls.update();
  renderer.render(scene,camera);
});

/* ===== XR ===== */
async function startXR(){
  if(!navigator.xr){ alert('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –û—Ç–∫—Ä–æ–π –≤ Quest Browser.'); return; }
  try{ const s=await navigator.xr.requestSession('immersive-vr',{optionalFeatures:['local-floor','bounded-floor']}); await renderer.xr.setSession(s); }
  catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å VR-—Å–µ—Å—Å–∏—é.'); }
}

/* ===== input / resize ===== */
addEventListener('click', ()=>{ ensureMusic(); triggerWave(); });
addEventListener('touchstart', ()=>{ ensureMusic(); triggerWave(); }, {passive:true});
addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='Enter'){ ensureMusic(); triggerWave(); } });
addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
