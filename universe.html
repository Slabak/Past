<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–¢–µ—Å—Å–µ—Ä–∞–∫—Ç ‚Äî —Ä–∞–∑–º—ã—Ç—ã–µ –ª–∏–Ω–∏–∏</title>
<script src="./assets/js/three.min.js"></script>
<script src="./assets/js/OrbitControls.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:30}
  .menu{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:20}
  .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;background:#14b8a6;color:#00100e;box-shadow:0 4px 20px rgba(0,0,0,.35)}
  .btn.secondary{background:#1f2937;color:#cbd5e1}
  .hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;font-size:13px;z-index:5}
  .mute{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:10px;font-size:13px;z-index:6;cursor:pointer}
  .quality{position:fixed;right:12px;top:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);padding:6px 8px;border-radius:10px;font-size:13px;z-index:7}
</style>
</head>
<body>
  <div id="loading" class="overlay"><div>–ì–æ—Ç–æ–≤–ª—é –ª–∏–Ω–∏–∏‚Ä¶</div></div>
  <div id="menu" class="menu">
    <button id="btnVR" class="btn">–í–æ–π—Ç–∏ –≤ VR</button>
    <button id="btnSpectate" class="btn secondary">–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è</button>
  </div>
  <div class="hud">–ü–ö: –º—ã—à—å ‚Äî –æ–±–∑–æ—Ä. –ö–ª–∏–∫ –≤–∫–ª—é—á–∞–µ—Ç –º—É–∑—ã–∫—É.</div>
  <button id="mute" class="mute">üîä –ú—É–∑—ã–∫–∞</button>
  <div class="quality">
    –ö–∞—á–µ—Å—Ç–≤–æ:
    <select id="qsel">
      <option value="auto">auto</option>
      <option value="low">low</option>
      <option value="med">med</option>
      <option value="high">high</option>
    </select>
  </div>

<script>
/*** –¥–µ—Ç–µ–∫—Ç—ã ***/
const ua = navigator.userAgent;
const isQuest  = /Quest|Oculus/i.test(ua);
const isMobile = /Android|iPhone|iPad|iPod|Quest|Oculus/i.test(ua);

/*** —Å—Ü–µ–Ω–∞ ***/
const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
renderer.setPixelRatio(isMobile ? 1 : Math.min(window.devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.25;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 2000);
camera.position.set(0,1.6,0.01);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enabled = false; controls.target.set(0,1.6,0);

/*** –º—è–≥–∫–∏–π —Ñ–µ–π–¥, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´—á—ë—Ä–Ω–æ–≥–æ –∑–∞–ª–∏–ø–∞–Ω–∏—è¬ª –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ VR ***/
function makeFade(){const g=new THREE.PlaneGeometry(2,2),m=new THREE.MeshBasicMaterial({color:0x000,transparent:true,opacity:1,depthTest:false});const q=new THREE.Mesh(g,m);q.renderOrder=9999;q.position.z=-0.3;camera.add(q);scene.add(camera);return{show:()=>m.opacity=1,fade:(ms=700)=>{const t0=performance.now();(function f(t){const k=Math.min(1,(t-t0)/ms);m.opacity=1-k;if(k<1)requestAnimationFrame(f)})(t0)}}}
const screen = makeFade(); let xrFadePending=false, xrFrames=0;

/*** –∫–∞—á–µ—Å—Ç–≤–æ ***/
function pickQuality(){
  const v = document.getElementById('qsel').value;
  if (v!=='auto') return v;
  if (isQuest) return 'low';
  return isMobile ? 'med' : 'high';
}
function qualityParams(q){
  // distance ‚Äî –æ—Ç–æ–¥–≤–∏–≥–∞–µ–º —Ä–µ—à—ë—Ç–∫—É –ø–æ–¥–∞–ª—å—à–µ; stroke ‚Äî —Ç–æ–ª—â–∏–Ω–∞ ¬´—è–¥—Ä–∞¬ª –ª–∏–Ω–∏–∏
  if(q==='low')  return {cell:3, count:2, distance:3.6, fillDensity:6, stroke:0.06, falloff:1.8, layers:2, streaks:60};
  if(q==='med')  return {cell:3, count:3, distance:3.8, fillDensity:8, stroke:0.055,falloff:2.0, layers:2, streaks:90};
  /* high */     return {cell:3, count:3, distance:4.0, fillDensity:11,stroke:0.05, falloff:2.2, layers:3, streaks:120};
}

/*** —Ä–∏—Å—É–µ–º –º—è–≥–∫—É—é –ª–∏–Ω–µ–π–Ω—É—é —Ç–µ–∫—Å—Ç—É—Ä—É (—è–¥—Ä–æ + —Ä–∞–∑–º—ã—Ç—ã–π –∫—Ä–∞–π) ***/
function makeLineTexture(){
  const w=512,h=64, c=document.createElement('canvas'); c.width=w; c.height=h;
  const ctx=c.getContext('2d');
  // –ø–æ–ø–µ—Ä–µ—á–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç: —è—Ä–∫–æ–µ —è–¥—Ä–æ –≤ —Ü–µ–Ω—Ç—Ä–µ, –∫ –∫—Ä–∞—è–º —Å–ø–∞–¥
  const g=ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0.00,'rgba(255,255,255,0.0)');
  g.addColorStop(0.35,'rgba(255,255,255,0.25)');
  g.addColorStop(0.50,'rgba(255,255,255,0.9)');
  g.addColorStop(0.65,'rgba(255,255,255,0.25)');
  g.addColorStop(1.00,'rgba(255,255,255,0.0)');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,w,h);
  const t=new THREE.CanvasTexture(c);
  t.generateMipmaps=false; t.minFilter=THREE.LinearFilter; t.magFilter=THREE.LinearFilter;
  if ('colorSpace' in t) t.colorSpace = THREE.SRGBColorSpace; else t.encoding = THREE.sRGBEncoding;
  return t;
}
const lineTex = makeLineTexture();

/*** –º–∞—Ç–µ—Ä–∏–∞–ª ¬´—Ä–∞–∑–º—ã—Ç–æ–π –ª–∏–Ω–∏–∏¬ª (–¥–µ—à—ë–≤—ã–π –±–ª—é–º) ***/
function makeLineMaterial(opacity=0.6){
  return new THREE.MeshBasicMaterial({
    map: lineTex,
    color: 0xE9D7B5,     // —Ç—ë–ø–ª—ã–π –æ—Ç—Ç–µ–Ω–æ–∫
    transparent: true,
    opacity,
    blending: THREE.AdditiveBlending,
    depthWrite: false,
    side: THREE.DoubleSide
  });
}

/*** –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ—è-—Ä–µ—à—ë—Ç–∫–∏ –∏–∑ —Ä–∞–∑–º—ã—Ç—ã—Ö –ª–∏–Ω–∏–π (–∏–Ω—Å—Ç–∞–Ω—Å–∏–Ω–≥) ***/
function buildBlurGrid(P, phase=0, tintMul=1.0){
  const {cell,count,distance,fillDensity,stroke,falloff} = P;
  const group = new THREE.Group();

  const half = cell/2;
  const steps = fillDensity;
  const step  = cell/(steps+1);

  // –ø–ª–æ—Å–∫–∞—è ¬´–ª–∏–Ω–∏—è¬ª: –ø–æ –¥–ª–∏–Ω–µ ‚Äî cell, –ø–æ —Ç–æ–ª—â–∏–Ω–µ ‚Äî stroke (—è–¥—Ä–æ) * falloff (—Ä–∞–∑–º—ã—Ç–∏–µ –ø–æ –∫—Ä–∞—è–º —Ç–µ–∫—Å—Ç—É—Ä–æ–π)
  const geoX = new THREE.PlaneGeometry(cell, stroke*falloff);
  const geoY = new THREE.PlaneGeometry(cell, stroke*falloff);
  const geoZ = new THREE.PlaneGeometry(cell, stroke*falloff);

  const matCore = makeLineMaterial(0.55 * tintMul);
  const matSoft = makeLineMaterial(0.22 * tintMul);

  // —Ç—Ä–∏ –Ω–∞–±–æ—Ä–∞: X,Y,Z
  const estLinesPerAxis = (count*2+1) * (count*2+1) * (steps+2); // –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
  const lineX = new THREE.InstancedMesh(geoX, matCore, estLinesPerAxis);
  const lineY = new THREE.InstancedMesh(geoY, matCore, estLinesPerAxis);
  const lineZ = new THREE.InstancedMesh(geoZ, matCore, estLinesPerAxis);

  const haloX = new THREE.InstancedMesh(geoX, matSoft, estLinesPerAxis);
  const haloY = new THREE.InstancedMesh(geoY, matSoft, estLinesPerAxis);
  const haloZ = new THREE.InstancedMesh(geoZ, matSoft, estLinesPerAxis);

  let ix=0, iy=0, iz=0, hx=0, hy=0, hz=0;
  const M = new THREE.Matrix4(), R = new THREE.Matrix4();

  // –ø–æ–≤–æ—Ä–æ—Ç—ã –¥–ª—è –ø–ª–æ—Å–∫–æ—Å—Ç–µ–π: X (–≥–æ—Ä–∏–∑–æ–Ω—Ç), Y (–≤–µ—Ä—Ç–∏–∫–∞–ª—å —Å–ø–µ—Ä–µ–¥–∏-–Ω–∞–∑–∞–¥), Z (–≤–µ—Ä—Ç–∏–∫–∞–ª—å —Å–ª–µ–≤–∞-–≤–ø—Ä–∞–≤–æ)
  const RX = new THREE.Matrix4().makeRotationZ(Math.PI/2); // X-–ª–∏–Ω–∏–∏: –ø–ª–æ—Å–∫–æ—Å—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞
  const RY = new THREE.Matrix4().makeRotationX(Math.PI/2);
  const RZ = new THREE.Matrix4().makeRotationY(Math.PI/2);

  function push(inst, Mtx, idx){ inst.setMatrixAt(idx, Mtx); }

  for(let gx=-count; gx<=count; gx++)
  for(let gy=-count; gy<=count; gy++)
  for(let gz=-count; gz<=count; gz++){
    const cx=gx*cell, cy=1.6+gy*cell, cz=gz*cell;
    // ¬´–ø—É—Å—Ç–æ—Ç–∞¬ª –≤–æ–∫—Ä—É–≥ –∑—Ä–∏—Ç–µ–ª—è
    if (Math.hypot(cx,cy-1.6,cz) < distance + cell*0.35) continue;

    // —Ä–∞–º–∫–∏ –∫–æ–º–Ω–∞—Ç—ã ‚Äî —á–µ—Ç—ã—Ä–µ —Ä–µ–±—Ä–∞ –ø–æ –∫–∞–∂–¥–æ–π –æ—Å–∏
    // X-–æ—Å–∏ (–ø–æ —É–≥–ª–∞–º –ø–æ Z/Y)
    [
      [cx, cy - half, cz - half, RX],
      [cx, cy - half, cz + half, RX],
      [cx, cy + half, cz - half, RX],
      [cx, cy + half, cz + half, RX],
    ].forEach(([x,y,z,rot])=>{
      M.identity().multiply(rot).setPosition(x,y,z); push(lineX,M,ix++); push(haloX,M,hx++);
    });

    // Y-–æ—Å–∏
    [
      [cx - half, cy, cz - half, RY],
      [cx + half, cy, cz - half, RY],
      [cx - half, cy, cz + half, RY],
      [cx + half, cy, cz + half, RY],
    ].forEach(([x,y,z,rot])=>{
      M.identity().multiply(rot).setPosition(x,y,z); push(lineY,M,iy++); push(haloY,M,hy++);
    });

    // Z-–æ—Å–∏
    [
      [cx - half, cy - half, cz, RZ],
      [cx + half, cy - half, cz, RZ],
      [cx - half, cy + half, cz, RZ],
      [cx + half, cy + half, cz, RZ],
    ].forEach(([x,y,z,rot])=>{
      M.identity().multiply(rot).setPosition(x,y,z); push(lineZ,M,iz++); push(haloZ,M,hz++);
    });

    // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ¬´–ø—Ä—É—Ç—å—è¬ª ‚Äî —à–∞–≥–∞–º–∏ –≤–Ω—É—Ç—Ä—å —è—á–µ–π–∫–∏
    for(let i=1;i<=steps;i++){
      const d=-half + i*step;
      // –≤–¥–æ–ª—å X (—Ä–∞—Å–∫–ª–∞–¥ –ø–æ Z)
      [[cx, cy, cz + d, RX],[cx, cy, cz - d, RX]].forEach(([x,y,z,rot])=>{
        M.identity().multiply(rot).setPosition(x,y,z); push(lineX,M,ix++); push(haloX,M,hx++);
      });
      // –≤–¥–æ–ª—å Z (—Ä–∞—Å–∫–ª–∞–¥ –ø–æ Y)
      [[cx, cy + d, cz, RZ],[cx, cy - d, cz, RZ]].forEach(([x,y,z,rot])=>{
        M.identity().multiply(rot).setPosition(x,y,z); push(lineZ,M,iz++); push(haloZ,M,hz++);
      });
      // –≤–¥–æ–ª—å Y (—Ä–∞—Å–∫–ª–∞–¥ –ø–æ X)
      [[cx + d, cy, cz, RY],[cx - d, cy, cz, RY]].forEach(([x,y,z,rot])=>{
        M.identity().multiply(rot).setPosition(x,y,z); push(lineY,M,iy++); push(haloY,M,hy++);
      });
    }
  }

  [lineX,lineY,lineZ,haloX,haloY,haloZ].forEach(im=>{ im.count = Math.min(im.count, im.instanceMatrix.count); im.instanceMatrix.needsUpdate=true; group.add(im); });

  // ¬´—Å–≤–µ—Ç–æ–≤—ã–µ –ø–æ—Ç—ë–∫–∏¬ª ‚Äî –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Å—ã, –º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—É—Ç
  const streakGeo = new THREE.PlaneGeometry(2.6*cell, P.stroke?P.stroke*P.falloff*1.2:0.12);
  const streakMat = makeLineMaterial(0.22*tintMul);
  const streaks   = new THREE.InstancedMesh(streakGeo, streakMat, P.streaks);
  const M2 = new THREE.Matrix4();
  for(let i=0;i<P.streaks;i++){
    const axis=(Math.random()*3)|0;
    const ring=((Math.random()*(count*2+1))|0)-count;
    const base=ring*cell, h=half;
    let x=0,y=1.6,z=0,rx=0,ry=0;
    if(axis===0){ y=1.6+(Math.random()*2-1)*h; z=(Math.random()<.5?-1:1)*h + base; ry=Math.PI/2; }
    if(axis===1){ x=(Math.random()<.5?-1:1)*h + base; z=(Math.random()*2-1)*h; rx=Math.PI/2; }
    if(axis===2){ x=(Math.random()*2-1)*h + base; y=1.6+(Math.random()<.5?-1:1)*h; }
    M2.identity().makeRotationFromEuler(new THREE.Euler(rx,ry,0)).setPosition(x,y,z);
    streaks.setMatrixAt(i,M2);
  }
  streaks.instanceMatrix.needsUpdate=true;
  streaks.userData.tick=(t)=>{
    // –µ–ª–µ-–∑–∞–º–µ—Ç–Ω—ã–π —Å–¥–≤–∏–≥, —á—Ç–æ–±—ã —à–ª–µ–π—Ñ ¬´–¥—ã—à–∞–ª¬ª
    streaks.position.z = Math.sin(t*0.35 + phase)*0.18;
  };
  group.add(streaks);

  group.userData.tick=(t)=>{
    // –¥—Ä–µ–π—Ñ –≤—Å–µ–≥–æ —Å–ª–æ—è
    group.position.z = Math.sin(t*0.45 + phase)*0.22;
    const s = 1.00 + 0.02*Math.sin(t*0.6 + phase);
    group.scale.set(1.00, 1.00*s, 1.00/s);
  };
  return group;
}

/*** —Å–±–æ—Ä–∫–∞ —Å—Ü–µ–Ω—ã –∏–∑ 2‚Äì3 —Å–ª–æ—ë–≤ ***/
let root=null;
function rebuild(){
  if(root){ scene.remove(root); root.traverse(o=>{ if(o.dispose) o.dispose(); }); root=null; }
  const q = pickQuality();
  const P = qualityParams(q);

  root = new THREE.Group();
  const layers = Math.max(2, P.layers||2);
  for(let i=0;i<layers;i++){
    const tint = 0.9 + i*0.05;
    root.add( buildBlurGrid(P, i*1.2, tint) );
  }
  root.userData.tick=(t)=>{ root.children.forEach(ch=>{ if(ch.userData.tick) ch.userData.tick(t); }); };
  scene.add(root);
}

/*** –º—É–∑—ã–∫–∞ ***/
const MUSIC_PATH = './assets/music/universe.mp3';
let audioCtx=null, musicNode=null, musicGain=null, musicStarted=false, musicMuted=false;
async function ensureMusic(){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(musicStarted) return;
    const resp=await fetch(MUSIC_PATH); const buf=await resp.arrayBuffer();
    const audioBuf=await audioCtx.decodeAudioData(buf);
    musicGain=audioCtx.createGain(); musicGain.gain.value=0.0001;
    musicNode=audioCtx.createBufferSource(); musicNode.buffer=audioBuf; musicNode.loop=true;
    musicNode.connect(musicGain).connect(audioCtx.destination); musicNode.start();
    const t=audioCtx.currentTime; musicGain.gain.exponentialRampToValueAtTime(0.10, t+2.0);
    musicStarted=true; updateMuteUI();
  }catch(e){ console.warn('–ú—É–∑—ã–∫–∞ –Ω–µ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª–∞:',e); }
}
function setMuted(m){ musicMuted=m; if(musicGain){ const t=audioCtx.currentTime; musicGain.gain.cancelScheduledValues(t); musicGain.gain.exponentialRampToValueAtTime(m?0.0001:0.10, t+0.25);} updateMuteUI();}
function toggleMute(){ setMuted(!musicMuted); }
function updateMuteUI(){ document.getElementById('mute').textContent = musicMuted ? 'üîá –ë–µ–∑ –∑–≤—É–∫–∞' : 'üîä –ú—É–∑—ã–∫–∞'; }

/*** –º–µ–Ω—é / VR ***/
const loading=document.getElementById('loading');
const menu=document.getElementById('menu');
requestAnimationFrame(()=>{ rebuild(); loading.style.display='none'; menu.style.display='flex'; });

renderer.xr.addEventListener('sessionstart', ()=>{
  controls.enabled=false; screen.show(); xrFadePending=true; xrFrames=0; ensureMusic();
});
document.getElementById('btnVR').onclick = async ()=>{ menu.style.display='none'; screen.show(); await startXR(); };
document.getElementById('btnSpectate').onclick = ()=>{ menu.style.display='none'; controls.enabled=true; screen.show(); ensureMusic(); setTimeout(()=>screen.fade(700),150); };
document.getElementById('mute').onclick = ()=>{ ensureMusic().then(()=>toggleMute()); };

/*** —Ü–∏–∫–ª ***/
renderer.setAnimationLoop(()=>{
  const now=performance.now()*0.001;
  if (renderer.xr.isPresenting && xrFadePending){ xrFrames++; if(xrFrames>=4){ screen.fade(700); xrFadePending=false; } }
  if(root && root.userData.tick) root.userData.tick(now);
  if(controls.enabled) controls.update();
  renderer.render(scene,camera);
});

/*** XR ***/
async function startXR(){
  if(!navigator.xr){ alert('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –û—Ç–∫—Ä–æ–π –≤ Quest Browser.'); return; }
  try{ const s=await navigator.xr.requestSession('immersive-vr',{optionalFeatures:['local-floor','bounded-floor']}); await renderer.xr.setSession(s); }
  catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å VR-—Å–µ—Å—Å–∏—é.'); }
}

/*** input / resize ***/
addEventListener('click', ()=>{ ensureMusic(); });
addEventListener('touchstart', ()=>{ ensureMusic(); }, {passive:true});
addEventListener('keydown', e=>{ if(e.code==='KeyM'){ ensureMusic().then(()=>toggleMute()); } });
addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
