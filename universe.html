<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>–¢–µ—Å—Å–µ—Ä–∞–∫—Ç ‚Äî –∫–∏–Ω–æ—à–Ω—ã–π, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π</title>
<script src="./assets/js/three.min.js"></script>
<script src="./assets/js/OrbitControls.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial}
  .loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:30;flex-direction:column;gap:10px}
  .bar{width:240px;height:6px;background:#222;border-radius:6px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:#14b8a6}
  .menu{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:20}
  .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;background:#14b8a6;color:#00100e;box-shadow:0 4px 20px rgba(0,0,0,.35)}
  .btn.secondary{background:#1f2937;color:#cbd5e1}
  .hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;font-size:13px;z-index:5}
  .mute{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:10px;font-size:13px;z-index:6;cursor:pointer}
</style>
</head>
<body>
  <div id="loading" class="loading">
    <div>–°–æ–±–∏—Ä–∞—é —Ç–µ—Å—Å–µ—Ä–∞–∫—Ç‚Ä¶</div>
    <div class="bar"><i id="bar"></i></div>
  </div>

  <div id="menu" class="menu">
    <button id="btnVR" class="btn">–í–æ–π—Ç–∏ –≤ VR</button>
    <button id="btnSpectate" class="btn secondary">–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è</button>
  </div>

  <div class="hud">–ö–ª–∏–∫/—Ç–∞–ø/–ø—Ä–æ–±–µ–ª ‚Äî ¬´—Å—Ç—É–∫¬ª (–º—è–≥–∫–∞—è –≤–æ–ª–Ω–∞ + –≤—Å–ø—ã—à–∫–∞ —Ñ–æ—Ç–æ). –í–∑–≥–ª—è–¥ –≤ —Ü–µ–Ω—Ç—Ä —Ç–æ–∂–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.</div>
  <button id="mute" class="mute">üîä –ú—É–∑—ã–∫–∞</button>

<script>
/* ===== –∑–∞–≥—Ä—É–∑–∫–∞ ===== */
const manager = new THREE.LoadingManager();
manager.onProgress = (_url, loaded, total)=>{ document.getElementById('bar').style.width = ((loaded/total)*100|0)+'%'; };
manager.onLoad = ()=>{ loading.style.display='none'; menu.style.display='flex'; };
manager.onError = ()=>{ loading.style.display='none'; menu.style.display='flex'; };
const texLoader = new THREE.TextureLoader(manager);

/* ===== renderer/camera/scene ===== */
const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
const isMobile = /Android|iPhone|iPad|iPod|Quest|Oculus/i.test(navigator.userAgent);
renderer.setPixelRatio(isMobile ? 1 : Math.min(window.devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
renderer.xr.enabled = true;
if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.25; // —á—É—Ç—å —è—Ä—á–µ
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.01, 400);
camera.position.set(0,1.6,0.01);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enabled = false; controls.target.set(0,1.6,0);

/* ===== fade + XR fix ===== */
function makeFade(){const g=new THREE.PlaneGeometry(2,2),m=new THREE.MeshBasicMaterial({color:0x000,transparent:true,opacity:1,depthTest:false});const q=new THREE.Mesh(g,m);q.renderOrder=9999;q.position.z=-0.3;camera.add(q);scene.add(camera);return{show:()=>m.opacity=1,fade:(ms=700)=>{const t0=performance.now();(function f(t){const k=Math.min(1,(t-t0)/ms);m.opacity=1-k;if(k<1)requestAnimationFrame(f)})(t0)}}}
const screen = makeFade();
let xrFadePending=false, xrFrameCount=0;

/* ===== —Å–≤–µ—Ç ‚Äî —Ç—ë–ø–ª—ã–π, –º—è–≥–∫–∏–π ===== */
const key = new THREE.DirectionalLight(0xffe0b5, 0.35); key.position.set(-2,5,-4); scene.add(key);
const rim = new THREE.DirectionalLight(0x9bbfff, 0.12); rim.position.set(3,2,3); scene.add(rim);
scene.add(new THREE.AmbientLight(0x120d08, 0.55));

/* ===== ¬´—Å—Ç–µ–ª–ª–∞–∂–∏¬ª: –æ–±—ä—ë–º–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ (Box), –∞ –Ω–µ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ ===== */
const racks = new THREE.Group(); scene.add(racks);

function woodTexture(){
  const c=document.createElement('canvas'); c.width=1024; c.height=64; const ctx=c.getContext('2d');
  for(let x=0; x<c.width; x++){
    const hue=35+Math.random()*10, sat=25+Math.random()*20, l=14+Math.random()*10;
    ctx.fillStyle=`hsl(${hue} ${sat}% ${l}%)`;
    ctx.fillRect(x,0,1,c.height);
  }
  const t=new THREE.CanvasTexture(c); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.repeat.set(8,1); t.colorSpace=THREE.SRGBColorSpace;
  return t;
}
const wood = woodTexture();

function addRackLayers(axis='x', layers=8, spacing=1.0, size={w:12,h:3.2, d:0.08}, innerGap=1.2){
  // —Å–ª–æ–∏ –∏–¥—É—Ç –¥–∞–ª—å—à–µ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—É—Å—Ç–æ–≥–æ –æ–±—ä—ë–º–∞
  // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ¬´–ø—É—Å—Ç–æ–π –∫—É–±¬ª ~2.4–º: +-innerGap –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
  const halfOffset = innerGap + spacing * 0.5;
  for(let i=0;i<layers;i++){
    const sign = (i%2===0) ? 1 : -1;
    const step = halfOffset + Math.floor(i/2)*spacing;
    const geo = new THREE.BoxGeometry(size.w, size.h, size.d);
    const mat = new THREE.MeshStandardMaterial({map:wood, roughness:0.95, metalness:0.05, color:0xffffff});
    const m = new THREE.Mesh(geo, mat);
    if(axis==='x'){ m.rotation.y = Math.PI/2; m.position.set(sign*step, 1.6, 0); }
    if(axis==='y'){ m.rotation.x = Math.PI/2; m.position.set(0, 1.6+sign*step, 0); }
    if(axis==='z'){ m.position.set(0, 1.6, sign*step); }
    m.castShadow = false; m.receiveShadow = false;
    racks.add(m);
  }
}
addRackLayers('x', 10, 0.9, {w:14,h:3.6,d:0.08}, 1.2);
addRackLayers('y', 10, 0.9, {w:14,h:3.6,d:0.08}, 1.2);
addRackLayers('z', 10, 0.9, {w:14,h:3.6,d:0.08}, 1.2);

// –ª—ë–≥–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã (–±–µ–∑ —Å—Ç—Ä–æ–±–æ–≤)
racks.userData.update=(dt,t)=>{
  const a=0.18;
  racks.position.z = Math.sin(t*0.08)*0.35;
  racks.position.x = Math.sin(t*0.06+1.3)*0.25;
  racks.rotation.y = Math.sin(t*0.03)*0.02;
};

/* ===== —Ñ–æ—Ç–æ: 1..15, –ø–æ–≤–µ—Ä—Ö, –º–∞–ª–µ–Ω—å–∫–∏–µ ===== */
const photos = new THREE.Group(); racks.add(photos);
const photoTex = [];
for(let i=1;i<=15;i++){
  const url=`./assets/textures/photos/${i}.jpg`;
  texLoader.load(url, t=>{ t.colorSpace=THREE.SRGBColorSpace; photoTex.push(t); });
}

function placePhotos(){
  const N = Math.min(15, Math.max(3, photoTex.length));
  const geo = new THREE.PlaneGeometry(0.26, 0.16);
  for(let i=0;i<N;i++){
    const m = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({
      map: photoTex[i%photoTex.length],
      transparent:true, opacity:0, depthTest:false, depthWrite:false
    }));
    m.renderOrder = 10; // –ø–æ–≤–µ—Ä—Ö
    const side = (Math.random()*3)|0; const s = 2.1; // –≤–Ω—É—Ç—Ä–∏ –ø—É—Å—Ç–æ–≥–æ —è–¥—Ä–∞
    if(side===0){ m.position.set(Math.random()<.5?-s:s, 1.0+Math.random()*1.6, (Math.random()-0.5)*1.8); m.rotation.y=(Math.random()<.5? Math.PI/2 : -Math.PI/2); }
    else if(side===1){ m.position.set((Math.random()-0.5)*1.8, Math.random()<.5?(1.6-0.9):(1.6+0.9), (Math.random()-0.5)*1.8); m.rotation.x=(Math.random()<.5? Math.PI/2 : -Math.PI/2); }
    else { m.position.set((Math.random()-0.5)*1.8, 1.0+Math.random()*1.6, Math.random()<.5?-s:s); m.rotation.y=(Math.random()<.5? 0 : Math.PI); }
    m.userData.t0=Math.random()*6; m.userData.flashT=-1000;
    photos.add(m);
  }
}
manager.onLoad = ()=>{ loading.style.display='none'; menu.style.display='flex'; placePhotos(); };

/* ===== –º—É–∑—ã–∫–∞ –∏ ¬´—Å—Ç—É–∫¬ª ===== */
let audioCtx=null, musicNode=null, musicGain=null, musicStarted=false, musicMuted=false;
async function ensureMusic(){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(musicStarted) return;
    const resp=await fetch('./assets/music/universe.mp3'); const buf=await resp.arrayBuffer();
    const audioBuf=await audioCtx.decodeAudioData(buf);
    musicGain=audioCtx.createGain(); musicGain.gain.value=0.0001;
    musicNode=audioCtx.createBufferSource(); musicNode.buffer=audioBuf; musicNode.loop=true;
    musicNode.connect(musicGain).connect(audioCtx.destination); musicNode.start();
    const t=audioCtx.currentTime; musicGain.gain.exponentialRampToValueAtTime(0.10, t+2.0);
    musicStarted=true; updateMuteUI();
  }catch(e){ console.warn('–ú—É–∑—ã–∫—É –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å:', e); }
}
function setMuted(m){ musicMuted=m; if(musicGain){ const t=audioCtx.currentTime; musicGain.gain.cancelScheduledValues(t); musicGain.gain.exponentialRampToValueAtTime(m?0.0001:0.10, t+0.25);} updateMuteUI(); }
function toggleMute(){ setMuted(!musicMuted); }
function updateMuteUI(){ document.getElementById('mute').textContent = musicMuted ? 'üîá –ë–µ–∑ –∑–≤—É–∫–∞' : 'üîä –ú—É–∑—ã–∫–∞'; }

function thump(){ // –º—è–≥–∫–∏–π ¬´—Å—Ç—É–∫¬ª
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const t=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(95,t);
  g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.22,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.5);
  o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+0.52);
}
function cameraShake(){let t0=performance.now();(function tick(){const dt=(performance.now()-t0)/1000,k=Math.max(0,0.35-dt);camera.position.x=0.006*Math.sin(dt*40)*k;camera.position.y=1.6+0.004*Math.sin(dt*55)*k;if(k>0)requestAnimationFrame(tick);else{camera.position.x=0;camera.position.y=1.6;}})();}
function flashRandomPhoto(){ if(!photos.children.length) return; const m=photos.children[(Math.random()*photos.children.length)|0]; m.userData.flashT=performance.now()*0.001; }
function triggerWave(){ ensureMusic(); thump(); cameraShake(); flashRandomPhoto(); }

/* ===== –≤–∑–≥–ª—è–¥-—Ç—Ä–∏–≥–≥–µ—Ä ===== */
let gazeStart=0,gazing=false;
function checkGazeTrigger(){
  const f=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
  const toCenter=new THREE.Vector3(0,1.6,0).sub(camera.position).normalize();
  const angle=THREE.MathUtils.radToDeg(Math.acos(THREE.MathUtils.clamp(f.dot(toCenter),-1,1)));
  const ok=angle<8; if(ok){ if(!gazing){gazing=true;gazeStart=performance.now();} else if(performance.now()-gazeStart>1200){gazing=false; triggerWave();} } else {gazing=false;}
}

/* ===== XR/–º–µ–Ω—é ===== */
const loading=document.getElementById('loading');
const menu=document.getElementById('menu');
renderer.xr.addEventListener('sessionstart', ()=>{
  controls.enabled=false;
  screen.show();
  xrFadePending = true;
  xrFrameCount = 0;   // –∂–¥—ë–º –ø–æ–±–æ–ª—å—à–µ ‚Äî 4 –∫–∞–¥—Ä–∞
  ensureMusic();
});
document.getElementById('btnVR').onclick   = async ()=>{ menu.style.display='none'; screen.show(); await startXR(); };
document.getElementById('btnSpectate').onclick = ()=>{ menu.style.display='none'; controls.enabled=true; screen.show(); ensureMusic(); setTimeout(()=>screen.fade(700),150); };
document.getElementById('mute').onclick = ()=>{ ensureMusic().then(()=>toggleMute()); };

/* ===== main loop (XR-fade –Ω–∞ 4 –∫–∞–¥—Ä–∞) ===== */
renderer.setAnimationLoop(()=>{
  if (renderer.xr.isPresenting && xrFadePending) {
    xrFrameCount++;
    if (xrFrameCount >= 4) { screen.fade(700); xrFadePending = false; }
  }
  const t=performance.now()*0.001;
  if (racks.userData.update) racks.userData.update(1/60,t);

  // —Ñ–æ—Ç–æ: –º—è–≥–∫–∏–µ —Ü–∏–∫–ª—ã + –∫–æ—Ä–æ—Ç–∫–∞—è –≤—Å–ø—ã—à–∫–∞
  photos.children.forEach(m=>{
    const tt=(t + (m.userData.t0||0)) % 10.0;
    const fadeIn = THREE.MathUtils.clamp((tt-1.0)/1.2,0,1);
    const fadeOut= THREE.MathUtils.clamp((tt-6.8)/1.2,0,1);
    let op=fadeIn*(1-fadeOut)*0.75;
    if(t-(m.userData.flashT||-1000)<0.8){ const k=1-(t-m.userData.flashT)/0.8; op=Math.max(op,0.35+0.55*k); m.scale.setScalar(1.0+0.05*k);} else m.scale.setScalar(1.0);
    m.material.opacity=op;
  });

  checkGazeTrigger();
  if(controls.enabled) controls.update();
  renderer.render(scene,camera);
});

/* ===== XR ===== */
async function startXR(){
  if(!navigator.xr){ alert('WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –û—Ç–∫—Ä–æ–π –≤ Quest Browser.'); return; }
  try{ const s=await navigator.xr.requestSession('immersive-vr',{optionalFeatures:['local-floor','bounded-floor']}); await renderer.xr.setSession(s); }
  catch(e){ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å VR-—Å–µ—Å—Å–∏—é.'); }
}

/* ===== input / resize ===== */
addEventListener('click', ()=>{ ensureMusic(); triggerWave(); });
addEventListener('touchstart', ()=>{ ensureMusic(); triggerWave(); }, {passive:true});
addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='Enter'){ ensureMusic(); triggerWave(); } });
addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
