<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>VR Room — Будущее</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ЛОКАЛЬНЫЕ скрипты -->
  <script src="./assets/js/three.min.js"></script>
  <script src="./assets/js/OrbitControls.js"></script>
  <script src="./assets/js/GLTFLoader.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .loading{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:30}
    .spinner{width:38px;height:38px;border-radius:50%;border:3px solid #333;border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .menu{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:20}
    .menu h1{margin:0 0 8px;font-size:20px;font-weight:600}
    .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;background:#14b8a6;color:#00100e;box-shadow:0 4px 20px rgba(0,0,0,.35)}
    .btn.secondary{background:#1f2937;color:#cbd5e1}
    .hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.5);padding:8px 10px;border-radius:10px;font-size:13px;z-index:5}
  </style>
</head>
<body>
  <!-- Чёрный экран до загрузки ассетов -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loadingText">Загрузка…</div>
  </div>

  <!-- Меню выбора -->
  <div id="menu" class="menu">
    <h1>Комната будущего</h1>
    <button id="btnVR" class="btn">Войти в VR</button>
    <button id="btnSpectate" class="btn secondary">Режим наблюдателя</button>
  </div>

  <div class="hud">Комната: 4×4×3 м. Без лучей/телепорта. «Неонка» настроена.</div>

  <script>
  // ===== Пути под твою структуру =====
  const PATH = { models:'./assets/models/', textures:'./assets/textures/' };
  const FILES = { model:'future.glb', floor:'floorf.jpg', wall:'wallf.jpg', ceiling:'potolokf.jpg' };
  const ROOM = { size:4, height:3 };

  // ===== Renderer / XR =====
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
  const isMobile = /Android|iPhone|iPad|iPod|Quest|Oculus/i.test(navigator.userAgent);
  renderer.setPixelRatio(isMobile ? 1 : Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  if (renderer.xr.setFoveation) renderer.xr.setFoveation(1.0);
  document.body.appendChild(renderer.domElement);

  // ===== Scene / Camera =====
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x05070d);
  scene.fog = new THREE.Fog(0x05070d, 5.5, 12); // лёгкий туман

  const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
  camera.position.set(0, 1.6, ROOM.size * 0.45);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enabled = false;
  controls.target.set(0, 1.6, 0);

  // ===== Встроенная «шторка» (чёрный внутри VR/наблюдателя) + устойчивый фейд =====
  function makeScreenFade(){
    const geom = new THREE.PlaneGeometry(2, 2);
    const mat  = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 1, depthTest: false });
    const mesh = new THREE.Mesh(geom, mat);
    mesh.renderOrder = 9999; mesh.position.z = -0.3;
    camera.add(mesh); scene.add(camera);
    return {
      show: ()=> mat.opacity = 1,
      fadeOut: (ms=700)=>{ const t0 = performance.now(); (function step(t){ const k=Math.min(1,(t-t0)/ms); mat.opacity=1-k; if(k<1) requestAnimationFrame(step);})(t0); }
    };
  }
  const screenFade = makeScreenFade();

  // ===== Свет (мягкий ключ + cyan/magenta; ослабили контровой) =====
  scene.add(new THREE.HemisphereLight(0x91a4ff, 0x0a0d16, 0.45));

  const key = new THREE.DirectionalLight(0xffffff, 0.38);
  key.position.set(-1.6, 3.6, 1.4);
  key.castShadow = true;
  key.shadow.mapSize.set(1024,1024);
  key.shadow.camera.near = 0.1; key.shadow.camera.far = 10;
  key.shadow.bias = -0.0006; key.shadow.normalBias = 0.02;
  scene.add(key);

  // холодный заполняющий
  const fill = new THREE.PointLigh
