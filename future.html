<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>VR Room — Будущее</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- локальные скрипты -->
  <script src="./assets/js/three.min.js"></script>
  <script src="./assets/js/OrbitControls.js"></script>
  <script src="./assets/js/GLTFLoader.js"></script>

  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .loading{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:30}
    .spinner{width:38px;height:38px;border-radius:50%;border:3px solid #333;border-top-color:#fff;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .menu{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;z-index:20}
    .menu h1{margin:0 0 8px;font-size:20px;font-weight:600}
    .btn{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;background:#14b8a6;color:#00100e;box-shadow:0 4px 20px rgba(0,0,0,.35)}
    .btn.secondary{background:#1f2937;color:#cbd5e1}
    .hud{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,.5);padding:8px 10px;border-radius:10px;font-size:13px;z-index:5}
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loadingText">Загрузка…</div>
  </div>

  <div id="menu" class="menu">
    <h1>Комната будущего</h1>
    <button id="btnVR" class="btn">Войти в VR</button>
    <button id="btnSpectate" class="btn secondary">Режим наблюдателя</button>
  </div>

  <div class="hud">4×4×3 м · без телепорта · «неонка» включена</div>

  <script>
  const PATH = { models:'./assets/models/', textures:'./assets/textures/' };
  const FILES = { model:'future.glb', floor:'floorf.jpg', wall:'wallf.jpg', ceiling:'potolokf.jpg' };
  const ROOM = { size:4, height:3 };

  // -------- renderer
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
  const isMobile = /Android|iPhone|iPad|iPod|Quest|Oculus/i.test(navigator.userAgent);
  renderer.setPixelRatio(isMobile ? 1 : Math.min(devicePixelRatio, 2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.xr.enabled = true;
  if ('outputColorSpace' in renderer) renderer.outputColorSpace = THREE.SRGBColorSpace; else renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.15; // чуть «сочного» света
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  if (renderer.xr.setFoveation) renderer.xr.setFoveation(1.0);
  document.body.appendChild(renderer.domElement);

  // -------- scene/camera
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x05070d);   // темнее фон
  scene.fog = new THREE.Fog(0x05070d, 5.5, 12);   // лёгкий туман

  const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);
  camera.position.set(0, 1.6, ROOM.size*0.45);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enabled = false;
  controls.target.set(0, 1.6, 0);

  // -------- внутренняя «шторка»
  function makeScreenFade(){
    const g = new THREE.PlaneGeometry(2,2);
    const m = new THREE.MeshBasicMaterial({ color:0x000000, transparent:true, opacity:1, depthTest:false });
    const mesh = new THREE.Mesh(g,m); mesh.renderOrder = 9999; mesh.position.z = -0.3;
    camera.add(mesh); scene.add(camera);
    return { show:()=>m.opacity=1, fadeOut:(ms=700)=>{ const t0=performance.now(); (function f(t){const k=Math.min(1,(t-t0)/ms); m.opacity=1-k; if(k<1) requestAnimationFrame(f);})(t0);} };
  }
  const screenFade = makeScreenFade();

  // -------- lights (киберпанк-микс: мягкий ключ + cyan/magenta)
  // базовый «небо/земля», минимальный — чтобы не плоско
  scene.add(new THREE.HemisphereLight(0x91a4ff, 0x0a0d16, 0.45));

  // ключевой направленный, мягкие тени
  const key = new THREE.DirectionalLight(0xffffff, 0.38);
  key.position.set(-1.6, 3.6, 1.4);
  key.castShadow = true;
  key.shadow.mapSize.set(1024,1024);
  key.shadow.camera.near = 0.1; key.shadow.camera.far = 10;
  key.shadow.bias = -0.0006; key.shadow.normalBias = 0.02;
  scene.add(key);

  // cyan-заполняющий (холодный) слева
  const fill = new THREE.PointLight(0x00e5ff, 0.8, 6.5);
  fill.position.set(-1.8, 1.2, -1.6);
  scene.add(fill);

  // magenta-контровой (тёплый) справа
  const rim = new THREE.PointLight(0xff3ea5, 0.6, 7.0);
  rim.position.set(1.7, 2.0, 1.2);
  scene.add(rim);

  // -------- текстуры
  const texLoader = new THREE.TextureLoader();
  const ANISO = 4;
  function sRGB(t){ if ('colorSpace' in t) t.colorSpace = THREE.SRGBColorSpace; else t.encoding = THREE.sRGBEncoding; return t; }
  function loadT(url){ const t = texLoader.load(url); t.wrapS=t.wrapT=THREE.RepeatWrapping; t.anisotropy=ANISO; return sRGB(t); }

  const tFloor   = loadT(PATH.textures + FILES.floor);
  const tWall    = loadT(PATH.textures + FILES.wall);
  const tCeiling = loadT(PATH.textures + FILES.ceiling);

  // крупнее тайлинг + затемняем материалом
  tFloor.repeat.set(1.3,1.3);
  tWall.repeat.set(1.2,1.0);
  tCeiling.repeat.set(1.2,1.2);

  // -------- геометрия комнаты (материалы с тёмной «подложкой»)
  { // пол
    const g = new THREE.PlaneGeometry(ROOM.size, ROOM.size);
    const m = new THREE.MeshStandardMaterial({ map:tFloor, color:0x1c2126, roughness:0.95, metalness:0.0 });
    const mesh = new THREE.Mesh(g,m);
    mesh.rotation.x = -Math.PI/2; mesh.receiveShadow = true; scene.add(mesh);
  }
  { // потолок
    const g = new THREE.PlaneGeometry(ROOM.size, ROOM.size);
    const m = new THREE.MeshStandardMaterial({ map:tCeiling, color:0x0c0f14, roughness:0.98, metalness:0.0 });
    const ceil = new THREE.Mesh(g,m);
    ceil.rotation.x =  Math.PI/2; ceil.position.y = ROOM.height; scene.add(ceil);
  }
  { // стены
    const g = new THREE.PlaneGeometry(ROOM.size, ROOM.height);
    const m = new THREE.MeshStandardMaterial({ map:tWall, color:0x101217, roughness:0.98, metalness:0.0 });
    [
      {pos:[0,ROOM.height/2,-ROOM.size/2], rot:[0,0,0]},
      {pos:[0,ROOM.height/2, ROOM.size/2], rot:[0,Math.PI,0]},
      {pos:[-ROOM.size/2,ROOM.height/2,0], rot:[0, Math.PI/2, 0]},
      {pos:[ ROOM.size/2,ROOM.height/2,0], rot:[0,-Math.PI/2, 0]},
    ].forEach(s=>{
      const w = new THREE.Mesh(g,m); w.position.set(...s.pos); w.rotation.set(...s.rot);
      w.receiveShadow = true; scene.add(w);
    });
  }

  // -------- простые «неон-планки» на стенах
  function addNeon({x=0,y=1.2,z=-ROOM.size/2+0.01,len=1.6,rotY=0,color=0x00e5ff,intensity=3}={}){
    const geom = new THREE.BoxGeometry(len, 0.05, 0.02);
    const mat  = new THREE.MeshStandardMaterial({ color:0x111, emissive: color, emissiveIntensity:intensity, roughness:0.4, metalness:0.0 });
    const bar  = new THREE.Mesh(geom, mat);
    bar.position.set(x,y,z); bar.rotation.y = rotY; scene.add(bar); return bar;
  }
  addNeon({ x:0,   y:2.2, z:-ROOM.size/2+0.01, len:2.6, color:0x00e5ff, intensity:2.6 });
  addNeon({ x:ROOM.size/2-0.01, y:1.0, z:0, len:2.2, rotY:Math.PI/2, color:0xff3ea5, intensity:2.0 });

  // -------- загрузка GLB
  const loadingEl = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const menuEl = document.getElementById('menu');

  const manager = new THREE.LoadingManager();
  let assetsReady = false;
  manager.onStart    = () => loadingText.textContent = 'Загрузка…';
  manager.onProgress = (u,l,t) => loadingText.textContent = `Загрузка… ${l}/${t}`;
  manager.onLoad     = () => { assetsReady = true; loadingEl.style.display='none'; menuEl.style.display='flex'; };
  manager.onError    = (u) => loadingText.textContent = `Ошибка: ${u}`;

  const gltf = new THREE.GLTFLoader(manager);
  gltf.load(PATH.models + FILES.model, (g)=>{
    const obj = g.scene;
    obj.traverse(n=>{ if(n.isMesh){ n.castShadow = true; n.receiveShadow = true; }});
    obj.position.set(0,0,0);
    scene.add(obj);
    renderer.compile(scene, camera);
  });

  // -------- ручной XR
  async function startXR(){
    if (!navigator.xr) { alert('WebXR не поддерживается. Открой в Quest Browser.'); return; }
    try {
      const session = await navigator.xr.requestSession('immersive-vr', { optionalFeatures:['local-floor','bounded-floor'] });
      await renderer.xr.setSession(session);
    } catch(e){ console.error(e); alert('Не удалось запустить VR-сессию.'); }
  }

  // -------- UI
  document.getElementById('btnVR').onclick = async ()=>{
    menuEl.style.display='none'; screenFade.show(); await startXR(); await waitAssets(); setTimeout(()=>screenFade.fadeOut(700),200);
  };
  document.getElementById('btnSpectate').onclick = async ()=>{
    menuEl.style.display='none'; controls.enabled = true; screenFade.show(); await waitAssets(); setTimeout(()=>screenFade.fadeOut(700),200);
  };
  function waitAssets(){ return new Promise(r=>{ if(assetsReady) return r(); const t=setInterval(()=>{ if(assetsReady){clearInterval(t); r();}},50); }); }

  // -------- loop/resize
  addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight);
  });
  renderer.setAnimationLoop(()=>{ if (controls.enabled) controls.update(); renderer.render(scene,camera); });
  </script>
</body>
</html>
